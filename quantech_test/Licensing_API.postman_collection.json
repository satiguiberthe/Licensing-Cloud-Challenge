{
  "info": {
    "name": "Licensing Cloud Management API",
    "_postman_id": "licensing-cloud-api",
    "description": "API collection for testing the cloud licensing management system",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:8000/api",
      "type": "string"
    },
    {
      "key": "jwt_token",
      "value": "",
      "type": "string"
    },
    {
      "key": "application_id",
      "value": "",
      "type": "string"
    },
    {
      "key": "job_id",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "1. Setup & Authentication",
      "item": [
        {
          "name": "1.1 Create License (Admin)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('jwt_token', jsonData.token);",
                  "    console.log('License created and JWT Token saved:', jsonData.token);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"tenant_id\": \"demo-tenant-001\",\n  \"tenant_name\": \"Demo Company\",\n  \"max_apps\": 5,\n  \"max_executions_per_24h\": 100,\n  \"valid_from\": \"2025-01-01T00:00:00Z\",\n  \"valid_to\": \"2026-01-01T00:00:00Z\",\n  \"contact_email\": \"demo@company.com\",\n  \"contact_name\": \"Demo User\",\n  \"generate_token\": true\n}"
            },
            "url": {
              "raw": "{{base_url}}/licenses/",
              "host": ["{{base_url}}"],
              "path": ["licenses", ""]
            },
            "description": "Create a new license and automatically generate a JWT token. Token is saved in collection variables."
          }
        },
        {
          "name": "1.2 Generate New JWT Token",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 200) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('jwt_token', jsonData.token);",
                  "    console.log('New JWT Token generated:', jsonData.token);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"tenant_id\": \"demo-tenant-001\",\n  \"expires_in_hours\": 24\n}"
            },
            "url": {
              "raw": "{{base_url}}/tokens/generate/",
              "host": ["{{base_url}}"],
              "path": ["tokens", "generate", ""]
            },
            "description": "Generate a new JWT token for an existing tenant. Token is saved in collection variables."
          }
        }
      ],
      "description": "License creation and authentication endpoints"
    },
    {
      "name": "2. Application Management (Challenge Endpoints)",
      "item": [
        {
          "name": "POST /apps/register - Register Application",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('application_id', jsonData.id);",
                  "    console.log('Application ID saved:', jsonData.id);",
                  "}",
                  "",
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Response has application ID', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData).to.have.property('id');",
                  "    pm.expect(jsonData).to.have.property('name');",
                  "    pm.expect(jsonData).to.have.property('is_active');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"My Test Application\",\n  \"description\": \"Application for testing the licensing system\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/apps/register",
              "host": ["{{base_url}}"],
              "path": ["apps", "register"]
            },
            "description": "Register a new application. Enforces maxApps constraint atomically."
          }
        },
        {
          "name": "POST /apps/register - Test Max Apps Limit",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"App {{$randomInt}}\",\n  \"description\": \"Testing quota limit\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/apps/register",
              "host": ["{{base_url}}"],
              "path": ["apps", "register"]
            },
            "description": "Try to register multiple applications to test maxApps enforcement. Run this multiple times until you get a 403 error."
          }
        },
        {
          "name": "GET /applications - List Applications",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/applications/",
              "host": ["{{base_url}}"],
              "path": ["applications", ""]
            },
            "description": "List all applications for the authenticated tenant"
          }
        }
      ],
      "description": "Application registration and management endpoints"
    },
    {
      "name": "3. Job Execution (Challenge Endpoints)",
      "item": [
        {
          "name": "POST /jobs/start - Start Job",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    var jsonData = pm.response.json();",
                  "    pm.collectionVariables.set('job_id', jsonData.id);",
                  "    console.log('Job ID saved:', jsonData.id);",
                  "}",
                  "",
                  "pm.test('Status code is 201', function () {",
                  "    pm.response.to.have.status(201);",
                  "});",
                  "",
                  "pm.test('Job is running', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.status).to.eql('RUNNING');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"application_id\": \"{{application_id}}\",\n  \"name\": \"Test Job {{$timestamp}}\",\n  \"description\": \"Testing job execution\",\n  \"metadata\": {\n    \"test\": true\n  }\n}"
            },
            "url": {
              "raw": "{{base_url}}/jobs/start",
              "host": ["{{base_url}}"],
              "path": ["jobs", "start"]
            },
            "description": "Start a new job execution. Enforces 24-hour sliding window quota atomically."
          }
        },
        {
          "name": "POST /jobs/finish - Complete Job",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 200', function () {",
                  "    pm.response.to.have.status(200);",
                  "});",
                  "",
                  "pm.test('Job is completed', function () {",
                  "    var jsonData = pm.response.json();",
                  "    pm.expect(jsonData.status).to.eql('COMPLETED');",
                  "    pm.expect(jsonData).to.have.property('finished_at');",
                  "    pm.expect(jsonData).to.have.property('execution_time');",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"job_id\": \"{{job_id}}\",\n  \"status\": \"COMPLETED\",\n  \"result\": {\n    \"success\": true,\n    \"output\": \"Job completed successfully\"\n  },\n  \"cpu_usage\": 45.5,\n  \"memory_usage\": 512\n}"
            },
            "url": {
              "raw": "{{base_url}}/jobs/finish",
              "host": ["{{base_url}}"],
              "path": ["jobs", "finish"]
            },
            "description": "Mark a job as completed or failed"
          }
        },
        {
          "name": "POST /jobs/finish - Fail Job",
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"job_id\": \"{{job_id}}\",\n  \"status\": \"FAILED\",\n  \"error_message\": \"Simulated error for testing\",\n  \"result\": {},\n  \"cpu_usage\": 25.0,\n  \"memory_usage\": 256\n}"
            },
            "url": {
              "raw": "{{base_url}}/jobs/finish",
              "host": ["{{base_url}}"],
              "path": ["jobs", "finish"]
            },
            "description": "Mark a job as failed"
          }
        },
        {
          "name": "GET /jobs - List Jobs",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/jobs/?limit=50",
              "host": ["{{base_url}}"],
              "path": ["jobs", ""],
              "query": [
                {
                  "key": "limit",
                  "value": "50"
                },
                {
                  "key": "application_id",
                  "value": "{{application_id}}",
                  "disabled": true
                },
                {
                  "key": "status",
                  "value": "RUNNING",
                  "disabled": true
                }
              ]
            },
            "description": "List jobs with optional filters"
          }
        }
      ],
      "description": "Job execution endpoints"
    },
    {
      "name": "4. Quota & Statistics",
      "item": [
        {
          "name": "GET /executions/window - Execution Window",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/executions/window/?hours=24",
              "host": ["{{base_url}}"],
              "path": ["executions", "window", ""],
              "query": [
                {
                  "key": "hours",
                  "value": "24"
                }
              ]
            },
            "description": "Get execution history within the sliding window"
          }
        },
        {
          "name": "GET /jobs/statistics - Job Statistics",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/jobs/statistics/",
              "host": ["{{base_url}}"],
              "path": ["jobs", "statistics", ""]
            },
            "description": "Get comprehensive job statistics for the tenant"
          }
        },
        {
          "name": "GET /applications/metrics - Application Metrics",
          "request": {
            "method": "GET",
            "header": [
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}"
              }
            ],
            "url": {
              "raw": "{{base_url}}/applications/metrics/",
              "host": ["{{base_url}}"],
              "path": ["applications", "metrics", ""]
            },
            "description": "Get aggregate metrics for all applications"
          }
        }
      ],
      "description": "Quota status and statistics endpoints"
    },
    {
      "name": "5. Race Condition Tests",
      "item": [
        {
          "name": "Concurrent Job Start (Run 10x in parallel)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "// Track success/failure",
                  "if (pm.response.code === 201) {",
                  "    console.log('✅ Job started successfully');",
                  "} else if (pm.response.code === 429) {",
                  "    console.log('❌ Quota exceeded (expected if near limit)');",
                  "} else {",
                  "    console.log('⚠️  Unexpected response:', pm.response.code);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"application_id\": \"{{application_id}}\",\n  \"name\": \"Concurrent Job {{$timestamp}}\",\n  \"description\": \"Race condition test\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/jobs/start",
              "host": ["{{base_url}}"],
              "path": ["jobs", "start"]
            },
            "description": "Use Postman Collection Runner to run this 10 times in parallel. The system should correctly enforce quota limits even under concurrency."
          }
        },
        {
          "name": "Concurrent App Register (Run 10x in parallel)",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "if (pm.response.code === 201) {",
                  "    console.log('✅ App registered successfully');",
                  "} else if (pm.response.code === 403) {",
                  "    console.log('❌ Max apps reached (expected if at limit)');",
                  "} else {",
                  "    console.log('⚠️  Unexpected response:', pm.response.code);",
                  "}"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer {{jwt_token}}"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Concurrent App {{$randomInt}}\",\n  \"description\": \"Race condition test for maxApps\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/apps/register",
              "host": ["{{base_url}}"],
              "path": ["apps", "register"]
            },
            "description": "Use Postman Collection Runner to run this 10 times in parallel. The system should correctly enforce maxApps limit."
          }
        }
      ],
      "description": "Test race condition prevention mechanisms"
    },
    {
      "name": "6. Security Tests",
      "item": [
        {
          "name": "No Token - Should Fail 401",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 401', function () {",
                  "    pm.response.to.have.status(401);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Unauthorized App\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/apps/register",
              "host": ["{{base_url}}"],
              "path": ["apps", "register"]
            },
            "description": "Attempt to register without authentication"
          }
        },
        {
          "name": "Invalid Token - Should Fail 401",
          "event": [
            {
              "listen": "test",
              "script": {
                "exec": [
                  "pm.test('Status code is 401', function () {",
                  "    pm.response.to.have.status(401);",
                  "});"
                ],
                "type": "text/javascript"
              }
            }
          ],
          "request": {
            "method": "POST",
            "header": [
              {
                "key": "Content-Type",
                "value": "application/json"
              },
              {
                "key": "Authorization",
                "value": "Bearer invalid.token.here"
              }
            ],
            "body": {
              "mode": "raw",
              "raw": "{\n  \"name\": \"Invalid Token App\"\n}"
            },
            "url": {
              "raw": "{{base_url}}/apps/register",
              "host": ["{{base_url}}"],
              "path": ["apps", "register"]
            },
            "description": "Attempt to use an invalid/forged token"
          }
        }
      ],
      "description": "Security and authentication tests"
    }
  ]
}
